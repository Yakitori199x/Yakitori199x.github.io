<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Java 8 in action 学习笔记(4) - Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hexo"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hexo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Java 8 in action 第十章、第十一章学习笔记"><meta property="og:type" content="blog"><meta property="og:title" content="Java 8 in action 学习笔记(4)"><meta property="og:url" content="http://example.com/2021/01/05/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Java_8_in_action/Java_8_in_action_Chapter_10_11/"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="Java 8 in action 第十章、第十一章学习笔记"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/images/Notes/Java_8_in_action/Combining_two_independent_asynchronous_tasks.png"><meta property="article:published_time" content="2021-01-05T14:48:07.519Z"><meta property="article:modified_time" content="2021-01-06T12:22:40.079Z"><meta property="article:author" content="John Doe"><meta property="article:tag" content="Java"><meta property="article:tag" content="读书笔记"><meta property="article:tag" content="Optional"><meta property="article:tag" content="Future"><meta property="article:tag" content="Asynchronous"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/Notes/Java_8_in_action/Combining_two_independent_asynchronous_tasks.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/01/05/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Java_8_in_action/Java_8_in_action_Chapter_10_11/"},"headline":"Hexo","image":["http://example.com/images/Notes/Java_8_in_action/Combining_two_independent_asynchronous_tasks.png"],"datePublished":"2021-01-05T14:48:07.519Z","dateModified":"2021-01-06T12:22:40.079Z","author":{"@type":"Person","name":"John Doe"},"description":"Java 8 in action 第十章、第十一章学习笔记"}</script><link rel="canonical" href="http://example.com/2021/01/05/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Java_8_in_action/Java_8_in_action_Chapter_10_11/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/vs2015.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="${date_xml(page.date)}" title="${date_xml(page.date)}">2021-01-05</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2021-01-06</time></span><span class="level-item"><a class="link-muted" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a><span> / </span><a class="link-muted" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Java-8-in-action/">Java 8 in action</a></span><span class="level-item">14 minutes read (About 2172 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Java 8 in action 学习笔记(4)</h1><div class="content"><p>Java 8 in action 第十章、第十一章学习笔记</p>
<a id="more"></a>

<h1 id="Chapter-10-Using-Optional-as-a-better-alternative-to-null"><a href="#Chapter-10-Using-Optional-as-a-better-alternative-to-null" class="headerlink" title="Chapter 10. Using Optional as a better alternative to null"></a>Chapter 10. Using Optional as a better alternative to null</h1><h2 id="Problems-with-null-10-1-2"><a href="#Problems-with-null-10-1-2" class="headerlink" title="Problems with null (10.1.2)"></a>Problems with null (10.1.2)</h2><ul>
<li>It’s a source of error. <strong>NullPointerException</strong> is by far the most common exception in Java.</li>
<li>It bloats your code. It <strong>worsens readability</strong> by making it necessary to fill your code with often <strong>deeply nested null checks</strong>.</li>
<li>It’s meaningless. It doesn’t have any <strong>semantic meaning</strong>, and in particular it represents the wrong way to model the absence of a value in a statically typed language.</li>
<li>It breaks Java philosophy. Java always <strong>hides pointers from developers</strong> except in one case: the null pointer.</li>
<li>It creates a hole in the type system. <strong>null carries no type or other information</strong>, meaning it can be assigned to any reference type. This is a problem because, when it’s propagated to another part of the system, you have no idea <strong>what that null was initially supposed to be</strong>.</li>
</ul>
<h2 id="Using-optionals-in-a-domain-model-and-why-they’re-not-Serializable-10-3-3"><a href="#Using-optionals-in-a-domain-model-and-why-they’re-not-Serializable-10-3-3" class="headerlink" title="Using optionals in a domain model and why they’re not Serializable (10.3.3)"></a>Using optionals in a domain model and why they’re not Serializable (10.3.3)</h2><p>Optional class在设计的时候没有考虑直接用在filed type上，也就是说，它的预想用例并不是直接将fields直接声明为Optional<XX>。所以，Optional没有实现Serializable接口，意味着如果某个class包含了Optional field，序列化的过程就会失败。</p>
<p>如果你需要让你的model能够被序列化，一个可取的方法是fields的声明还是保持不变，但是在method上进行修改。比如以下的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Car car;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Optional&lt;Car&gt; <span class="title">getCarAsOptional</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(car);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为Person不一定都拥有Car，所以Car是存在缺失的可能的。这时我们不是将Car声明为Optional<Car>，而是在get method里返回Optional<Car>，同时兼顾了Optional和Serializable。getCarAsOptional()也提醒client，Car是可能缺失的这一层含义。</p>
<h2 id="OrElseGet"><a href="#OrElseGet" class="headerlink" title="OrElseGet"></a>OrElseGet</h2><p><strong>orElseGet(Supplier&lt;? extends T&gt; other)</strong> is the lazy counterpart of the <strong>orElse</strong> method, because the supplier is invoked only if the optional contains no value. You should use this method either <strong>when the default value is time-consuming to create</strong> (to gain a little efficiency) or you want to <strong>be sure this is done only if the optional is empty</strong> (in which case it’s strictly necessary).</p>
<h1 id="Chapter-11-CompletableFuture-composable-asynchronous-programming"><a href="#Chapter-11-CompletableFuture-composable-asynchronous-programming" class="headerlink" title="Chapter 11. CompletableFuture: composable asynchronous programming"></a>Chapter 11. CompletableFuture: composable asynchronous programming</h1><h2 id="Synchronous-vs-Asynchronous-API-11-1-2"><a href="#Synchronous-vs-Asynchronous-API-11-1-2" class="headerlink" title="Synchronous vs. Asynchronous API (11.1.2)"></a>Synchronous vs. Asynchronous API (11.1.2)</h2><ul>
<li>Synchronous API<br>You call a method, the caller then waits while the method computes, the method then returns, and the caller continues with the returned value. Even if the caller and callee were executed on different threads, the caller would still wait for the callee to complete; this gives rise to the phrase blocking call.</li>
<li>Asynchronous API<br>The method returns immediately, or at least before its computation is complete, delegating its remaining computation to a thread, which runs asynchronously to the caller, hence the phrase non-blocking call.</li>
</ul>
<h2 id="Implementing-an-asynchronous-API-11-2"><a href="#Implementing-an-asynchronous-API-11-2" class="headerlink" title="Implementing an asynchronous API (11.2)"></a>Implementing an asynchronous API (11.2)</h2><p>在这个例子中，我们模拟通过service提供的API来获取对应产品的价格，最终计算出价格最便宜的产品的情景。</p>
<p>首先，我们给出一个synchronous API的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getPrice</span><span class="params">(String product)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> calculatePrice(product);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">double</span> <span class="title">calculatePrice</span><span class="params">(String product)</span> </span>&#123;</span><br><span class="line">	delay();</span><br><span class="line">	<span class="keyword">return</span> random.nextDouble() * product.charAt(<span class="number">0</span>) + product.charAt(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// delay用于模拟请求API到获得结果所花费的时间</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个synchronous API的实现有如下弊端：</p>
<p>When the consumer of this API (the best-price-finder application) invokes this method, it will remain blocked and then idle for 1 second while waiting for its synchronous completion. This is unacceptable, especially considering that the best-price-finder application will have to repeat this operation for all the shops in its network.</p>
<p>因此，我们需要做出一些改进，将其实现为asynchronous API，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;Double&gt; <span class="title">getPriceAsync</span><span class="params">(String product)</span> </span>&#123;</span><br><span class="line">	CompletableFuture&lt;Double&gt; futurePrice = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">new</span> Thread ( () -&gt; &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">double</span> price = calculatePrice(product);</span><br><span class="line">			<span class="comment">// Set the value returned by the long computation when it becomes available</span></span><br><span class="line">			futurePrice.complete(price);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="comment">// Complete it exceptionally with the Exception caused the failure</span></span><br><span class="line">			futurePrice.completeExceptionally(ex);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;).start();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Return the Future without waiting for the computation of the result it contains</span></span><br><span class="line">	<span class="keyword">return</span> futurePrice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中需要注意的是asynchronous task也是有可能出现错误的，虽然我们可以在获取Future的结果时设定一个timeout来避免无限地等待，但是这种方法最终只会throw TimeoutException，对于定位真正造成failure的原因是没有帮助的。因此，将Exception保存在Future里是更合理的做法。</p>
<p>最后，我们还可以通过supplyAsync factory method来更简洁地实现与上面的代码相同效果的代码（包括返回的结果和error management）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;Double&gt; <span class="title">getPriceAsync</span><span class="params">(String product)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; calculatePrice(product));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Parallel-and-Asynchronous-11-3"><a href="#Parallel-and-Asynchronous-11-3" class="headerlink" title="Parallel and Asynchronous (11.3)"></a>Parallel and Asynchronous (11.3)</h2><p>首先，我们假定shop提供的商品价格获取API都是synchronous的，那么一种方式是使用parallel stream：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findPrice</span><span class="params">(String product)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> shops.stream()</span><br><span class="line">        .map(shop -&gt; String.format(<span class="string">&quot;%s price is %.2f&quot;</span>, shop.getName(), shop.getPrice(product)))</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有一种方式就是使用异步请求CompletableFuture：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findPrice</span><span class="params">(String product)</span> </span>&#123;</span><br><span class="line">    List&lt;CompletableFuture&lt;String&gt;&gt; priceFutures = shops.stream()</span><br><span class="line">        .map(shop -&gt; CompletableFuture.supplyAsync(</span><br><span class="line">            () -&gt; String.format(<span class="string">&quot;%s price is %.2f&quot;</span>, shop.getName(), shop.getPrice(product))</span><br><span class="line">        ))</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * 这里分为两个stream进行处理的原因是:</span></span><br><span class="line"><span class="comment">     * 如果在第一个stream处直接接上map(CompletableFuture::join)，</span></span><br><span class="line"><span class="comment">     * 会造成向shop1发送getPrice的请求并返回future后，马上就调用join把当前thread阻塞，去等待shop1返回的结果。</span></span><br><span class="line"><span class="comment">     * 导致执行过程变为shop1.getprice() -&gt; join() -&gt; shop2.getprice() -&gt; join -&gt; ...，</span></span><br><span class="line"><span class="comment">     * 没有真正利用到async的特点。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> priceFutures.stream()</span><br><span class="line">        .map(CompletableFuture::join)</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当shop的数量为4且两个方法在4核CPU上运行时，parallel的方法耗时约为1s，而async方法耗时约为2s。这里是因为async需要threads之间的对CPU和内存的竞争以及上下文切换的开销。如果存在5个shop，那么parallel的情况下需要耗时约2s，因为需要等待4个先前的并行任务中的某个完成后才能发起新的task。相比之下，async可以通过定义custom executor的方式来scale。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Executor executor = Executors.newFixedThreadPool(</span><br><span class="line">    <span class="comment">// 防止shops数量过多使得线程池可允许的threads数量太多</span></span><br><span class="line">    <span class="comment">// threads数量太多会造成大量对CPU和内存的竞争以及上下文切换的开销</span></span><br><span class="line">    Math.min(shops.size(), <span class="number">100</span>),</span><br><span class="line">    <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(r);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * A Java program can’t terminate or exit while a normal thread is executing,</span></span><br><span class="line"><span class="comment">             * so a leftover thread waiting for a never-satisfiable event causes problems.</span></span><br><span class="line"><span class="comment">             * By contrast, marking a thread as a daemon means it can be killed on program termination.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> thread;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将custom executor用于findPrice中的CompletableFuture</span></span><br><span class="line">CompletableFuture.supplyAsync(</span><br><span class="line">            () -&gt; String.format(<span class="string">&quot;%s price is %.2f&quot;</span>, shop.getName(), shop.getPrice(product), executor);</span><br></pre></td></tr></table></figure>
<p>在使用custom executor的情况下，async方法中可以发起的threads数量不再局限于CPU核心数，再加上getPrice主要是Network I/O，即等待远端服务器计算返回结果，thread自身只负责发起请求但没有密集的计算，即使shops数量达到400，也可以在约为1s内获得所有的prices。</p>
<p>对于使用parallel还是async，主要取决于task是以compute为主，还是以wait为主：</p>
<ul>
<li>If you’re doing computation-heavy operations with no I/O, then the Stream interface gives the simplest implementation and one likely to be the most efficient (if all threads are compute-bound, then there’s no point in having more threads than processor cores).</li>
<li>On the other hand, if your parallel units of work involve waiting for I/O (including network connections), then CompletableFutures give more flexibility and the ability to match the number of threads to the wait/computer, or W/C, ratio.</li>
</ul>
<h2 id="Combine-independent-asynchronous-tasks-11-4"><a href="#Combine-independent-asynchronous-tasks-11-4" class="headerlink" title="Combine independent asynchronous tasks (11.4)"></a>Combine independent asynchronous tasks (11.4)</h2><p>One frequently occurring case is where you need to combine the results of the operations performed by <strong>two completely independent CompletableFutures</strong>, and you don’t want to wait for the first to complete before starting on the second.</p>
<p>Turning to our running example, you may know that one of the shops provides prices in €(EUR), but you always want to communicate them in $ (USD) to your customers. <strong>You can asynchronously ask the shop the price of a given product and retrieve, from a remote exchange-rate service, the current exchange rate between € and $</strong>. After both have completed, you can combine the results by multiplying the price by the exchange rate. The implementation could be:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;Double&gt; futurePriceInUSD = </span><br><span class="line">    CompletableFuture.supplyAsync(() -&gt; shop.getPrice(product))</span><br><span class="line">    	.thenCombine(</span><br><span class="line">    		CompletableFuture.supplyAsync(</span><br><span class="line">                () -&gt; exchangeService.getRate(Money.EUR, Money.USD)), </span><br><span class="line">    			(price, rate) -&gt; price * rate</span><br><span class="line">    		);</span><br></pre></td></tr></table></figure>
<p>The workflow of combining these two asynchronous tasks should be:</p>
<p><img src="/images/Notes/Java_8_in_action/Combining_two_independent_asynchronous_tasks.png" alt="Combining two independent asynchronous tasks"></p>
<h2 id="Reacting-to-a-CompletableFuture-completion-11-5"><a href="#Reacting-to-a-CompletableFuture-completion-11-5" class="headerlink" title="Reacting to a CompletableFuture completion (11.5)"></a>Reacting to a CompletableFuture completion (11.5)</h2><p>在一般情况下，向不同的shop请求getPrice，响应时间也各不相同。有时候我们想要实现一旦从某个shop获取的price被返回，我们就可以立刻使用这个price，而不需要等待所有tasks都被完成后再进行下一步处理。在这种场景下，我们可以使用thenAccept方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Stream&lt;CompletableFuture&lt;String&gt;&gt; findPricesStream(String product) &#123;</span><br><span class="line">    <span class="keyword">return</span> shops.stream()</span><br><span class="line">        .map(shop -&gt; CompletableFuture.supplyAsync(() -&gt; shop.getPrice(product), executor))</span><br><span class="line">        .map(future -&gt; future.thenApply(Quote::parse))</span><br><span class="line">        .map(future -&gt; future.thenCompose(</span><br><span class="line">            quote -&gt; CompletableFuture.supplyAsync(</span><br><span class="line">                () -&gt; Discount.applyDiscount(quote), executor)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CompletableFuture[] futures = findPricesStream(<span class="string">&quot;myPhone&quot;</span>)</span><br><span class="line">    .map(f -&gt; f.thenAccept(System.out::println))</span><br><span class="line">    .toArray(size -&gt; <span class="keyword">new</span> CompletableFuture[size]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The allOf factory method</span></span><br><span class="line"><span class="comment"> * Input: an array of CompletableFutures</span></span><br><span class="line"><span class="comment"> * Return: CompletableFuture&lt;Void&gt; </span></span><br><span class="line"><span class="comment"> *         that’s completed only when all the CompletableFutures passed have completed.</span></span><br><span class="line"><span class="comment"> * There is another method called anyOf()</span></span><br><span class="line"><span class="comment"> * it waits for the completion of only one of the CompletableFutures in an array.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CompletableFuture.allOf(futures).join();</span><br></pre></td></tr></table></figure>
<p>thenAccept() operation simply <strong>registers an action on each CompletableFuture</strong>; this action consumes the value of the CompletableFuture <strong>as soon as it completes</strong>. It also has an Async variant schedules the execution of the Consumer passed to it <strong>on a new thread</strong> from the thread pool <strong>instead of directly performing it using the same thread</strong> that completed the CompletableFuture. Because the thenAccept method already specifies how to consume the result produced by the CompletableFuture when it becomes available, it <strong>returns a Completable-Future<Void></strong>.</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Java 8 in action 学习笔记(4)</p><p><a href="http://example.com/2021/01/05/读书笔记/Java_8_in_action/Java_8_in_action_Chapter_10_11/">http://example.com/2021/01/05/读书笔记/Java_8_in_action/Java_8_in_action_Chapter_10_11/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>John Doe</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-01-05</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2021-01-06</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/Java/">Java, </a><a class="link-muted" rel="tag" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记, </a><a class="link-muted" rel="tag" href="/tags/Optional/">Optional, </a><a class="link-muted" rel="tag" href="/tags/Future/">Future, </a><a class="link-muted" rel="tag" href="/tags/Asynchronous/">Asynchronous </a></div></div><div class="notification is-danger">You need to set <code>install_url</code> to use ShareThis. Please set it in <code>_config.yml</code>.</div></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/01/06/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/The_Missing_Semester_of_Your_CS_Education_2020/1_Course%20overview_+_the_shell/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">1. Course overview + the shell</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/01/05/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/Java_8_in_action/Java_8_in_action_Chapter_08_09/"><span class="level-item">Java 8 in action 学习笔记(3)</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="notification is-danger">You forgot to set the <code>shortname</code> for Disqus. Please set it in <code>_config.yml</code>.</div></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Your name"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Your name</p><p class="is-size-6 is-block">Your title</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Your location</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">10</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">16</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Chapter-10-Using-Optional-as-a-better-alternative-to-null"><span class="level-left"><span class="level-item">1</span><span class="level-item">Chapter 10. Using Optional as a better alternative to null</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Problems-with-null-10-1-2"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">Problems with null (10.1.2)</span></span></a></li><li><a class="level is-mobile" href="#Using-optionals-in-a-domain-model-and-why-they’re-not-Serializable-10-3-3"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">Using optionals in a domain model and why they’re not Serializable (10.3.3)</span></span></a></li><li><a class="level is-mobile" href="#OrElseGet"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">OrElseGet</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Chapter-11-CompletableFuture-composable-asynchronous-programming"><span class="level-left"><span class="level-item">2</span><span class="level-item">Chapter 11. CompletableFuture: composable asynchronous programming</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Synchronous-vs-Asynchronous-API-11-1-2"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">Synchronous vs. Asynchronous API (11.1.2)</span></span></a></li><li><a class="level is-mobile" href="#Implementing-an-asynchronous-API-11-2"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">Implementing an asynchronous API (11.2)</span></span></a></li><li><a class="level is-mobile" href="#Parallel-and-Asynchronous-11-3"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">Parallel and Asynchronous (11.3)</span></span></a></li><li><a class="level is-mobile" href="#Combine-independent-asynchronous-tasks-11-4"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">Combine independent asynchronous tasks (11.4)</span></span></a></li><li><a class="level is-mobile" href="#Reacting-to-a-CompletableFuture-completion-11-5"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">Reacting to a CompletableFuture completion (11.5)</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2021 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>